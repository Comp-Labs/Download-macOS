name: Generate macOS Installer

on:
  workflow_dispatch:
    inputs:
      macos_version:
        type: choice
        description: "macOS Version"
        required: true
        options:
          - Tahoe v26.1
          - Sequoia v15.7.2
          - Sonoma v14.8.2
          - Ventura v13.7.8
          - Monterey v12.7.4
      file:
        type: choice
        description: "File Type"
        required: true
        options:
          - ISO
          - DMG
          - ZIP
          - TZST

run-name: Generate macOS Installer - ${{ github.event.inputs.macos_version }} ${{ github.event.inputs.file }}

env:
  installer_version: "" # Do not touch: Populated by extract-details (suppresses warnings)
  installer_name: "" # Do not touch: Populated by extract-details (suppresses warnings)

jobs:
  build:
    runs-on: macos-latest
    if: github.repository == 'Comp-Labs/Download-macOS'
    steps:
      - uses: actions/checkout@v4
      
      # Setup
      - name: Extract Version Details
        id: extract-details
        run: |
          string="${{ github.event.inputs.macos_version }}"
          echo "installer_version=${string//*v/}" >> $GITHUB_ENV
          echo "installer_name=${string// v*/}" >> $GITHUB_ENV

      # Download Installer
      - name: Download macOS Installer
        run: |
          softwareupdate --fetch-full-installer --full-installer-version ${{ env.installer_version }}

      # Generate Installer
      - if: github.event.inputs.file == 'dmg'
        name: Generate macOS DMG Installer
        run: |
          sudo hdiutil create -o /tmp/'${{ env.installer_name }}' -size 16384m -volname '${{ env.installer_name }}' -layout SPUD -fs HFS+J
          sudo hdiutil attach /tmp/'${{ env.installer_name }}'.dmg -noverify -mountpoint /Volumes/'${{ env.installer_name }}'
          sleep 10
          sudo /Applications/'Install macOS ${{ env.installer_name }}'.app/Contents/Resources/createinstallmedia --volume /Volumes/'${{ env.installer_name }}' --nointeraction
          hdiutil eject -force /Volumes/'Install macOS ${{ env.installer_name }}'
          sudo mv /tmp/'${{ env.installer_name }}'.dmg ~/Desktop/'${{ env.installer_name }}'.dmg

      - if: github.event.inputs.file == 'iso'
        name: Generate macOS ISO Installer
        run: |
          sudo rm -rf /Applications/Xcode*.app
          sudo rm -rf /Library/Developer/CommandLineTools
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf ~/.dotnet
          sudo rm -rf /usr/local/go
          sudo rm -rf /usr/local/julia*
          sudo rm -rf ~/Library/Developer/CoreSimulator
          xcrun simctl delete all 2>/dev/null || true
          sudo rm -rf ~/Library/Caches/*
          sudo rm -rf /Library/Caches/*
          sudo hdiutil create -o /tmp/"${INSTALLER_NAME}" -size 20480m -volname "${INSTALLER_NAME}" -layout SPUD -fs HFS+J -type SPARSE
          sudo hdiutil attach /tmp/"${INSTALLER_NAME}".app -noverify -mountpoint /Volumes/"${INSTALLER_NAME}"
          sleep 20
          echo "Creating install media..."
          sudo /Applications/"Install macOS ${INSTALLER_NAME}".app/Contents/Resources/createinstallmedia --volume /Volumes/"${INSTALLER_NAME}" --nointeraction
          echo "Sleeping 100 to allow the installer to finish"
          sleep 100
          hdiutil eject -force /Volumes/"Install macOS ${INSTALLER_NAME}" 2>/dev/null || \
          hdiutil detach /tmp/"${INSTALLER_NAME}".sparseimage -force 2>/dev/null || true
          hdiutil compact /tmp/"${INSTALLER_NAME}".sparseimage || true
          hdiutil convert /tmp/"${INSTALLER_NAME}".sparseimage -format UDTO -o /tmp/"${INSTALLER_NAME}"
          sudo rm -fv /tmp/"${INSTALLER_NAME}".sparseimage
          mv -v /tmp/"${INSTALLER_NAME}".cdr ~/Desktop/"${INSTALLER_NAME}".iso

      - if: github.event.inputs.file == 'zip'
        name: Generate macOS ZIP Installer
        run: |
          cd /Applications
          zip -r 'Install macOS ${{ env.installer_name }}.zip' 'Install macOS ${{ env.installer_name }}.app'
          mv -v 'Install macOS ${{ env.installer_name }}.zip' ~/Desktop/'${{ env.installer_name }}.zip'

      - if: github.event.inputs.file == 'tzst'
        name: Generate macOS TZST Installer
        run: |
          cd /Applications
          git clone https://github.com/rorosen/zeekstd.git
          cd zeekstd
          cargo build -p zeekstd_cli --release
          sudo cp ./target/release/zeekstd /usr/local/bin/
          cd ../
          tar -I 'zeekstd' -cvf 'Install macOS ${{ env.installer_name }}.tzst' 'Install macOS ${{ env.installer_name }}.app'
          mv -v 'Install macOS ${{ env.installer_name }}.tzst' ~/Desktop/'${{ env.installer_name }}.tzst'

      # Upload Installer
      - name: Upload ${{ github.event.inputs.file }}
        uses: actions/upload-artifact@v4
        with:
          name: macOS ${{ env.installer_name }}
          path: "~/Desktop/${{ env.installer_name }}.${{ github.event.inputs.file }}"
